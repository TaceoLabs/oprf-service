const { wasm } = require("circom_tester");
const { expect } = require("chai");
const path = require("path");

describe("Oprf Nullifier (d=30)", function () {
    this.timeout(10000);

    let circuit;
    before(async () => {
        circuit = await wasm(
            path.join(__dirname, "circuits/oprf_nullifier_test.circom"),
            { include: [path.join(__dirname, "../../")] },
        );
        await circuit.loadConstraints();
    });

    it("kat0 success", async () => {
        const witness = await circuit.calculateWitness(
            {
                pk: [
                    [
                        6965386590793264708828784385658692263001716816885017500803623616466274615316n,
                        6766771758192811672556849735217190738386351238640333163871897928122537114134n,
                    ],
                    [0n, 1n],
                    [0n, 1n],
                    [0n, 1n],
                    [0n, 1n],
                    [0n, 1n],
                    [0n, 1n],
                ],
                pk_index: 0n,
                s: 2004680850658357065985924097395029572041044474021270845782451250018062768876n,
                r: [
                    16748094490331690637225717897470849976599057835827392755882431563624582564174n,
                    11431458000618704133037487058864668621267848848721636358881641646632146234983n,
                ],
                cred_type_id:
                    20190259516226041765535175733124515720745657686832903050264448418767221065692n,
                cred_pk: [
                    18828693146366158325392378614872771864167848483645494464869161096273764242993n,
                    19562622010594901555398935095350396636038987044139912936647335079417248493112n,
                ],
                cred_hashes: [
                    19748150010931843358599336531664150705607072315440514915285455583399128194560n,
                    8693393019036216557387734023060483139055024449286784439774155492305800192519n,
                ],
                cred_genesis_issued_at: 6709729738978060427n,
                cred_expires_at: 9894894835796158030n,
                cred_s: 636533145993758858102923656120367245068129858805514650072771565286030073168n,
                cred_r: [
                    17437177818619291436244026169597540126472324735018358995962419168829333770375n,
                    7095403465468595947103728741608533490794519528947903506819522691191476588047n,
                ],
                current_timestamp: 1763463264n,
                merkle_root:
                    13177729401208501085028851284400765620386496083967465921108682114322210824482n,
                depth: 30n,
                mt_index: 0n,
                siblings: [
                    0n,
                    15621590199821056450610068202457788725601603091791048810523422053872049975191n,
                    15180302612178352054084191513289999058431498575847349863917170755410077436260n,
                    20846426933296943402289409165716903143674406371782261099735847433924593192150n,
                    19570709311100149041770094415303300085749902031216638721752284824736726831172n,
                    11737142173000203701607979434185548337265641794352013537668027209469132654026n,
                    11865865012735342650993929214218361747705569437250152833912362711743119784159n,
                    1493463551715988755902230605042557878234810673525086316376178495918903796315n,
                    18746103596419850001763894956142528089435746267438407061601783590659355049966n,
                    21234194473503024590374857258930930634542887619436018385581872843343250130100n,
                    14681119568252857310414189897145410009875739166689283501408363922419813627484n,
                    13243470632183094581890559006623686685113540193867211988709619438324105679244n,
                    19463898140191333844443019106944343282402694318119383727674782613189581590092n,
                    10565902370220049529800497209344287504121041033501189980624875736992201671117n,
                    5560307625408070902174028041423028597194394554482880015024167821933869023078n,
                    20576730574720116265513866548855226316241518026808984067485384181494744706390n,
                    11166760821615661136366651998133963805984915741187325490784169611245269155689n,
                    13692603500396323648417392244466291089928913430742736835590182936663435788822n,
                    11129674755567463025028188404867541558752927519269975708924528737249823830641n,
                    6673535049007525806710184801639542254440636510496168661971704157154828514023n,
                    7958154589163466663626421142270206662020519181323839780192984613274682930816n,
                    3739156991379607404516753076057250171966250101655747790592556040569841550790n,
                    1334107297020502384420211493664486465203492095766400031330900935069700302301n,
                    20357028769054354174264046872903423695314313082869184437966002491602414517674n,
                    19392290367394672558538719012722289280213395590510602524366987685302929990731n,
                    7360502715619830055199267117332475946442427205382059394111067387016428818088n,
                    9629177338475347225553791169746168712988898028547587350296027054067573957412n,
                    21877160135037839571797468541807904053886800340144060811298025652177410263004n,
                    7105691694342706282901391345307729036900705570482804586768449537652208350743n,
                    15888057581779748293164452094398990053773731478520540058125130669204703869637n,
                ],
                beta: 2129180912118824431732825153256333384818978408583179627112944444331305841704n,
                rp_id: 217763602579605696454276798326986720107n,
                action: 2571140311526166285939503361537388868310771999921000204079303945698719580966n,
                nonce: 14484432055544825564271444027934369967507132910968083621099741290620457416938n,
                dlog_e: 18761456603365533287637090351305089699604480184547912669208766477884758658873n,
                dlog_s: 2091045830164468149037059544362351126886703945780042273204901850862835991689n,
                oprf_pk: [
                    9745695617589199339520013197926451599203493904504441170880194075509854023822n,
                    3076214006320714894360992716092344621957846537656398842932757996511992163723n,
                ],
                oprf_response_blinded: [
                    18085361268840658947864177076968238495437954272821979350697570103721407287932n,
                    17568752465216739474489048184449879159798762070104437412737077023212281260290n,
                ],
                oprf_response: [
                    4204682551896804573878175709127780214510602262688717943723039063852762807407n,
                    9990453849922457038483284292581944722229600957478482678484613092449022170730n,
                ],
                signal_hash:
                    21173299053471100864949087772180311622842581942062594841309273715845712618981n,
                id_commitment_r:
                    17233924458728893936005056502490858314166362209293601778168172404642417032814n,
            },
            true,
        );
        await circuit.assertOut(witness, {
            id_commitment:
                3887925911775698437805795649422997807269059361066094904815218578537868642784n,
            nullifier:
                2555866431025072288869370172089291584200873670427964990942044759221394605312n,
        });
        await circuit.checkConstraints(witness);
    });
});
